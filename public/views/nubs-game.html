<dom-module id="nubs-game">
	<template>
		<style>
			:host {
				display: block;
			}
			.card-container{
				width: calc(100% - 5%);
				margin: 0 auto;
				display: flex;
				flex-direction: row;
    			flex-wrap:wrap;
			}
			.step-label{
				color: #dddddd;
				margin: 0px 10px;
			}
			.step-label.iron-selected{
				color: #911eb3;
			}
			paper-card{
				display: inline-block;
				margin:10px 0 0 0;
				flex-grow: 1;
				width: calc(100% 10px - 1px);
			}

			/*paper-icon-item{
				padding: 14px;
				display: block;
				margin:0 0 0 0;
				width: 100%;
				background-color: transparent;
				box-shadow: none;
				border-bottom: 1px solid #dddddd;
			}*/
			
			paper-card.player-card.list-header{
				background-color: #dddddd;
				color: #212121;
				border-radius: 0px;
				box-shadow: none;
				text-align: center;
			}
			.player-card-container.male{
				background-color: #636bd8;
				color: #ffffff;				
    			border-bottom: 1px solid #ffffff;
			}
			.player-card-container.female{
				background-color: #d863c9;
				color: #ffffff;				
    			border-bottom: 1px solid #ffffff;				
			}

			/*.badge{
				min-width: 22px;
				height: 22px;
				line-height: 22px;
				font-size: 12px;
				border-radius: 50%;
				background-color: #bfbfbf;
				color: #212121;
				display: inline-block;
				vertical-align: top;
			}*/
			.avatar.error{
				background-color: #E91E63;
				color: #ffffff;
			}
			paper-input{
				min-width: 150px;
				flex: 1 0;
				margin: 0px 5px;
			}
			paper-slider{
				width: 100%;
			}

			.game-header { @apply(--paper-font-headline); }
			.horizontal { @apply(--layout-horizontal); }
			.vertical {	@apply(--layout-vertical); }

			.buttonContainer{
				margin: 10px 0px;
			}
							
			paper-button.purple {
				background-color: var(--app-secondary-text-color) !important;
				color: #ffffff !important;
			}

			.gameData{
				width: calc(100% - 40px);
				margin: 0px 20px 0px 20px;
			}
			.dataInput{
				width: calc(100% - 100px);
				margin: 0px 50px 0px 50px;
			}
			
			.dataInputs{
				width: 100%;
				display: flex;
				justify-content: center;
				align-items: center;
			}
			.caption {
				padding-left: 12px;
				color: #a0a0a0;
			}
			.players-container{
				height: 300px;
				min-height: 300px;
				background-color: #dddddd;
				vertical-align: top;
				display: flex;
				justify-content: center;
				align-items: center;
			}
			.sortableColumn{
				display: inline-block;
				height: 100%;
				vertical-align: top;
				flex: 1
			}
			.sortableColumn paper-card{
				cursor: grab;
				cursor: -webkit-grab;
			}
			.sortableColumn paper-card.chosen{
				cursor: grabbing;
				cursor: -webkit-grabbing;
			}
			.sortableColumn.VS{
				width: 52px;
    			flex: 0;
				display: flex;
				flex-direction: column;
				align-items: flex-start;
			}

			.sortableColumn.VS .player-card-header{
				height: 48px;
				width: 50px;
			}
			
			.sortableColumn.VS paper-card{
				height: 67px;
				display: flex;
				justify-content: center;
				align-items: center;
				box-shadow: none;
				cursor: pointer;
			}
			.ghost {
				opacity: .5;
				background: #C8EBFB;
			}
			.avatar {
				border-radius: 50%;
				width: 30px;
				height: 30px;
				border: solid 2px #ffffff;
				vertical-align: top;
				margin-right: 16px;
				display: inline-block; 
			}
			.avatar.header{				
				text-align: center;
				line-height: 30px;
			}
			.player-info {
				display: inline-block; 
			}
		</style>

			<paper-stepper progress-bar no-buttons selected="{{selected}}">
				<paper-step></paper-step>
				<paper-step></paper-step>
				<paper-step></paper-step>
			</paper-stepper>
			<div class="card-container">
					<paper-card>
						<div class="card-content">
							<div class="game-header">[[game.name]]</div>
								<iron-pages selected="[[selected]]">
									<div>
										<p>
											<div>Players per session: <span class="caption">[[game.players]]</span></div>
											<div>Players to play game:<span class="caption"><paper-input label="" style="width:150px;display:inline-block;" value="{{playersToPlay}}"></paper-input></span></div>
											
										</p>
										<p>
											<div>Game Data Between Players:</div>
										</p>
										<div class="gameData">	
											<template is="dom-repeat" items="[[game.data]]" as="data">
												<template is="dom-if" if="{{data.type == 'RANGE'}}">
													<div>[[data.name]]: <span class="caption"></span></div>
														<div class="dataInput">															
															<div class="dataInputs">														
																<paper-input label="Minimum" value="{{data.min}}"></paper-input>
																<paper-input label="Maximun" value="{{data.max}}"></paper-input>
																<paper-input label="Default Value" value="{{data.default}}"></paper-input>
															</div>
															<div>Preview</div>
															<paper-slider id="[[data.key]]" pin snaps min="[[data.min]]" max="[[data.max]]" step="1" value="{{data.default}}" editable></paper-slider>
														</div>
													</template>
												</template>
											</div>
									</div>
									<div>
										<p>
											<div>Organise Players :</div>
										</p>
										<div class="buttonContainer">
											<paper-button raised class="purple" on-tap="_randomisePlayers">Randomise</paper-button>
										</div>
										<div class="players-container">
											<div id="playerAList" data-list="A" class="sortableColumn" role="listbox">	
												<div class="player-card-header">													
													<paper-icon-item class="player-card-header">
														<div class="avatar header" item-icon>[[playersA.length]]</div>
														<paper-item-body one-line>
															<div id="playersA" class="player-name">
																<span style="line-height: 20px;	font-size: 20px;color: #212121;">Player A</span>
															</div>
														</paper-item-body>
													</paper-icon-item>
												</div>
												<template is="dom-repeat" items="{{playersA}}" as="player">
													<div class$="player-card-container [[player.gender]]" data-col="A" id="playerA_{{index}}">
														<paper-icon-item class="player-card-header">
															<div class="" item-icon><img class="avatar" src="[[player.photoUrl]]"/></div>
															<paper-item-body two-line>
																<div class="player-name">[[player.name]]</div>
																<div class="player-age">{{_calculateAge(player.birthday)}}</div>
															</paper-item-body>
														</paper-icon-item>
													</div>
												</template>
											</div>
											<div id="playerVsList" class="sortableColumn VS">												
												<div class="player-card-header">												
													<paper-item class="" style="padding: 0px;height: 48px;width: 52px;">
														<div class="card-content">
															<div class="player-name">VS</div>
														</div>
													</paper-card>
												</div>
												
												<template is="dom-repeat" items="{{playersA}}">
													<div class$="player-card-container" style="padding: 0px;height: 48px;">											
														<paper-item one-line style="padding: 0px;height: 48px;width: 52px;">
															<div class="card-content">
																<div data-index$="{{index}}" on-tap="_swapPlayers">
																	<iron-icon icon="swap-horiz"></iron-icon>
																</div>
															</div>
														</paper-item>
													</div>
												</template>
											</div>
											<div id="playerBList" data-list="B" class="sortableColumn">
												<div class="player-card-header">													
													<paper-icon-item class="player-card-header">
														<div class="avatar header" item-icon>[[playersB.length]]</div>
														<paper-item-body one-line>
															<div id="playersB" class="player-name">
																<span style="line-height: 20px;	font-size: 20px;color: #212121;">Player B</span>
															</div>
														</paper-item-body>
													</paper-icon-item>
												</div>
												<template is="dom-repeat" items="{{playersB}}" as="player">
													<div class$="player-card-container [[player.gender]]" data-col="B" id="playerB_{{index}}">
														<paper-icon-item class="player-card-header">
															<div class="" item-icon><img class="avatar" src="[[player.photoUrl]]"/></div>
															<paper-item-body two-line>
																<div class="player-name">[[player.name]]</div>
																<div class="player-age">{{_calculateAge(player.birthday)}}</div>
															</paper-item-body>
														</paper-icon-item>
													</div>
												</template>
											</div>
										</div>
									</div>
									<div>
										<p>Sessions to be created : [[playersA.length]]</p>
										<paper-button raised on-tap="_createGameInstance">Create</paper-button>										
									</div>
								</iron-pages>
						</div>
						<div class="card-actions">
							<paper-stepper selected="{{selected}}">
								<paper-step class="step-label">Setup</paper-step>
								<paper-step class="step-label">Players</paper-step>
								<paper-step class="step-label">Create</paper-step>
							</paper-stepper>
						</div>
					</paper-card>
			</div>

		</template>
		<script>
				Polymer({
						is: 'nubs-game',
						properties: {
							game:{
								type: Object,
								observer: 'setPlayersToPlay'
							},
							players:{
								type: Array,
								observer: 'createSort'
							},
							playersToPlay:{
								type: Number,
								observer: 'createSort'
							},
							playersA:{
								type: Array
							},
							playersB:{
								type: Array
							},
							sortA:{
								type: Object
							},
							sortB:{
								type: Object
							},
							currentList:{
								type: String
							}
						},
						setPlayersToPlay: function(game){
							this.playersToPlay = game.playersToPlay;
						},
						createSort: function(){
							this._oddEvenPlayers();
							if(this.sortA && this.sortB){
								this.sortA.destroy();
								this.sortB.destroy();
							}
							var self = this;
							var playerAList = document.getElementById("playerAList");
							if(playerAList){
								this.sortA = Sortable.create(playerAList, {
									animation: 150, 
									draggable: ".player-card-container",
									group: "players",
									ghostClass: 'ghost',
									chosenClass: "chosen",
									onUpdate: function (evt) {
										self._updateUser(evt, "A");
									},
									onAdd: function (evt) {
										self._moveUser(evt, "A");
									}
								});
							}

							var playerBList = document.getElementById("playerBList");
							if(playerBList){
								this.sortB = Sortable.create(playerBList, {
									animation: 150, 
									draggable: ".player-card-container",
									group: "players",
									ghostClass: 'ghost',
									chosenClass: "chosen",
									onUpdate: function (evt) {
										self._updateUser(evt, "B");
									},
									onAdd: function (evt) {
										self._moveUser(evt, "B");
									}
								});
							}
						},
						_oddEvenPlayers: function(index){
							var arrA = [];
							var arrB = [];
							if(this.players){
								for (var i = 0; i<  this.players.length; i++){
									if ((i+2)%2 ==0) {
										arrA.push(this.players[i]);
									}
									else {
										arrB.push(this.players[i]);
									}
								}
							}
							this.set('playersA', arrA.splice(0, Number(this.playersToPlay)/2));
							this.set('playersB', arrB.splice(0, Number(this.playersToPlay)/2));
						},
						_moveUser: function(evt, origin){
							//var oldList = evt.target.dataset.list;console.log(evt)
							var oldIndex = evt.oldIndex;
							var newIndex = evt.newIndex;
							var col = evt.item.dataset.col;
							var playersA = this.playersA;
							var playersB = this.playersB;
							if(col == "A"){
								var i = playersA.splice(oldIndex, 1)[0];
								playersB.splice(newIndex, 0, i);
							}
							if(col == "B"){
								var i = playersB.splice(oldIndex, 1)[0];
								playersA.splice(newIndex, 0, i);
							}
							this.set('playersA', playersA);
							this.set('playersB', playersB);
							this._reNumberPlayers();
						},
						_updateUser: function(evt, origin){
							var oldIndex = evt.oldIndex;
							var newIndex = evt.newIndex;
							var col = evt.item.dataset.col;
							var playersA = this.playersA;
							var playersB = this.playersB;
							if(col == "A"){
								var i = playersA.splice(oldIndex, 1)[0];
								playersA.splice(newIndex, 0, i);
							}
							if(col == "B"){
								var i = playersB.splice(oldIndex, 1)[0];
								playersB.splice(newIndex, 0, i);
							}
							this.set('playersA', playersA);
							this.set('playersB', playersB);
							this._reNumberPlayers();
						},
						_swapPlayers: function(evt){
							var el = evt.target;
							var index = Number(el.parentElement.dataset.index);

							var elmA = document.getElementById("playerA_"+index);
							var elmB = document.getElementById("playerB_"+index);

							var sibA = document.getElementById("playerA_"+(index+1));
							var sibB = document.getElementById("playerB_"+(index+1));

							if(sibA && sibB){
								this.sortA.el.insertBefore(elmB, sibA);
								this.sortB.el.insertBefore(elmA, sibB);
							}
							else{
								this.sortA.el.appendChild(elmB);
								this.sortB.el.appendChild(elmA);
							}

							var playersA = this.playersA;
							var playersB = this.playersB;
							
							var a = playersA.splice(index, 1)[0];
							var b = playersB.splice(index, 1)[0];
							
							playersA.splice(index, 0, b);									
							playersB.splice(index, 0, a);

							this.set('playersA', playersA);
							this.set('playersB', playersB);

							this._reNumberPlayers();
						},
						_reNumberPlayers: function(){
							var sortA = this.sortA.el.childNodes;
							var sortB = this.sortB.el.childNodes;

							var a = 0;
							for(var i = 0; i < sortA.length; i++){
								if(sortA[i].classList && sortA[i].classList.contains('player-card-container')){
									sortA[i].dataset.col = "A";
									sortA[i].id = "playerA_"+a;
									a++;
								}
							}
							var b = 0;
							for(var i = 0; i < sortB.length; i++){
								if(sortB[i].classList && sortB[i].classList.contains('player-card-container')){
									sortB[i].dataset.col = "B";
									sortB[i].id = "playerB_"+b;
									b++;
								}
							}
							this.notifyPath('playersA.0', playersA[0]);
							this.notifyPath('playersB.0', playersB[0]);
							this.set('playersA.length', this.playersA.length);
							this.set('playersB.length', this.playersB.length);

							if(this.playersA.length != this.playersB.length){
								document.querySelectorAll(".avatar.header").forEach(function(a){
									a.classList.add("error");
								});
							}
							else{
								document.querySelectorAll(".avatar.header").forEach(function(a){
									a.classList.remove("error");
								});
							}
						},
						_randomisePlayers: function(){
							var players = FirebaseHelper.shuffleArray(this.players);
							this.set('players', players);
							this.createSort();
							this.notifyPath('playersA.0', playersA[0]);
							this.notifyPath('playersB.0', playersB[0]);
						},
						_calculateAge: function(birthday) {
							var d = new Date().getTime();
							var bd = new Date(birthday).getTime(); // miliseconds from epoch
							var diff = d - bd;
							var dd = new Date(diff);
    						return Math.abs(dd.getUTCFullYear() - 1970);
						},
						_createGameInstance: function(){
								var playersA = this.playersA;
								var playersB = this.playersB;
								var data = FirebaseHelper.arrayListToObject(this.game.data);
								var gameKey = Screen_NewGameInstance.gameKey;
								var name = this.game.name;
								FirebaseHelper.createGameInstance({
										playersA: playersA,
										playersB: playersB,
										data: data,
										gameKey: gameKey,
										name: name
								});
						}
				});
		</script>
</dom-module>
